<?xml version="1.0" encoding="utf-8"?>
<modification>
	<code>pvnm_profiler</code>
	<name>Profiler</name>
	<version>1.0.0</version>
	<author>p0v1n0m@gmail.com</author>
	<link>mailto:p0v1n0m@gmail.com</link>
	<file path="system/library/db.php">
		<operation>
			<search><![CDATA[
public function query($sql) {
			]]></search>
			<add position="replace" offset="2"><![CDATA[
	private $time = 0;
	private $queries = array();
	private $config = array();

	public function __destruct() {
		if ($this->config['pvnm_profiler_status']) {
			if ($this->config['pvnm_profiler_body_status']) {
				print_r('<pre style="font-size: 11px;">');
				print_r('Page: http://' . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'] . '<br>');

				if ($this->time >= $this->config['pvnm_profiler_page_time']) {
					print_r('Load Time SQL Queries: <span style="color: red !important;">' . $this->time . ' s</span><br>');
				} else {
					print_r('Load Time SQL Queries: ' . $this->time . ' s<br>');
				}

				print_r('SQL Queries (' . count($this->queries) . '):<br>');

				foreach ($this->queries as $query) {
					if ($query['time'] >= $this->config['pvnm_profiler_query_time']) {
						print_r('<span style="color: red !important;">' . $query['time'] . ' s - ' . $query['query'] . '</span><br>');
					} else {
						print_r('<span>' . $query['time'] . ' s - ' . $query['query'] . '</span><br>');
					}
				}

				print_r('</pre>');
			}

			if ($this->config['pvnm_profiler_console_status']) {
				$console_log = array();

				foreach ($this->queries as $query) {
					$console_log['queries'][] = $query['time'] . ' s - ' . $query['query'];
				}

				print_r('<script>console.info("Profiler: ' . $this->time . ' s - http://' . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'] . '");console.log(' . json_encode($console_log) . ');</script>');
			}

			if ($this->config['pvnm_profiler_page_write'] == 1 || ($this->config['pvnm_profiler_page_write'] == 2 && $this->time >= $this->config['pvnm_profiler_page_time'])) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "pvnm_loading SET url = '" . $this->db->escape($_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI']) . "', time = '" . (float)($this->time) . "', date = '" . $this->db->escape($this->queries[0]['date']) . "'");

				$loading_id = $this->db->getLastId();

				foreach ($this->queries as $query) {
					$console_log['queries'][] = $query['time'] . ' s - ' . $query['query'];

					$this->db->query("INSERT INTO " . DB_PREFIX . "pvnm_query SET 
						loading_id = '" . (int)$loading_id . "', 
						query = '" . $this->db->escape($query['query']) . "', 
						time = '" . (float)$query['time'] . "', 
						date = '" . $this->db->escape($query['date']) . "'
					");
				}
			}

			if ($this->config['pvnm_profiler_page_email'] && $this->time >= $this->config['pvnm_profiler_page_time']) {
				$input = array(
					'{url}',
					'{date}',
					'{time}',
					'{queries}'
				);

				$output = array(
					'url'     => 'http://' . $_SERVER['SERVER_NAME'] . $_SERVER['REQUEST_URI'],
					'date'    => $this->queries[0]['date'],
					'time'    => $this->time,
					'queries' => count($this->queries)
				);

				$subject = html_entity_decode(str_replace($input, $output, trim($this->config['pvnm_profiler_email_subject'][$this->config['config_admin_language']])), ENT_QUOTES, 'UTF-8');
				$message = html_entity_decode(str_replace($input, $output, $this->config['pvnm_profiler_email_message'][$this->config['config_admin_language']]), ENT_QUOTES, 'UTF-8');

				$html  = '<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">' . "\n";
				$html .= '<html>' . "\n";
				$html .= '  <head>' . "\n";
				$html .= '    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">' . "\n";
				$html .= '    <title>' . $subject . '</title>' . "\n";
				$html .= '  </head>' . "\n";
				$html .= '  <body>' . $message . '</body>' . "\n";
				$html .= '</html>' . "\n";

				$mail = new Mail();
				$mail->protocol = $this->config['config_mail_protocol'];
				$mail->parameter = $this->config['config_mail_parameter'];
				$mail->smtp_hostname = $this->config['config_mail_smtp_hostname'];
				$mail->smtp_username = $this->config['config_mail_smtp_username'];
				$mail->smtp_password = html_entity_decode($this->config['config_mail_smtp_password'], ENT_QUOTES, 'UTF-8');
				$mail->smtp_port = $this->config['config_mail_smtp_port'];
				$mail->smtp_timeout = $this->config['config_mail_smtp_timeout'];

				$mail->setTo($this->config['config_email']);
				$mail->setFrom($this->config['config_email']);
				$mail->setSender(html_entity_decode($this->config['config_name'], ENT_QUOTES, 'UTF-8'));
				$mail->setSubject($subject);
				$mail->setHtml($html);
				$mail->send();
			}
		}
	}

	public function query($sql) {
		$time_start = microtime(true);

		$query = $this->db->query($sql);

		if (substr($sql, 0, 32) == 'SELECT * FROM `' . DB_PREFIX . 'setting` WHERE') {
			$configs = array(
				'pvnm_profiler_status',
				'pvnm_profiler_body_status',
				'pvnm_profiler_console_status',
				'pvnm_profiler_query_time',
				'pvnm_profiler_page_time',
				'pvnm_profiler_page_write',
				'pvnm_profiler_page_email',
				'pvnm_profiler_email_subject',
				'pvnm_profiler_email_message',
				'config_mail_protocol',
				'config_mail_parameter',
				'config_mail_smtp_hostname',
				'config_mail_smtp_username',
				'config_mail_smtp_password',
				'config_mail_smtp_port',
				'config_mail_smtp_timeout',
				'config_email',
				'config_name',
				'config_admin_language'
			);

			foreach ($query->rows as $config) {
				if (in_array($config['key'], $configs)) {
					if (!$config['serialized']) {
						$this->config[$config['key']] = $config['value'];
					} else {
						$this->config[$config['key']] = json_decode($config['value'], true);
					}
				}
			}

		}

		$query_time = microtime(true) - $time_start;

		$this->time += $query_time;

		$this->queries[] = array(
			'query' => $sql,
			'time'  => $query_time,
			'date'  => date('Y.m.d H:i:s', $time_start)
		);

		return $query;
	}
			]]></add>
		</operation>
	</file>
</modification>